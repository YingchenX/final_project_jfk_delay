---
title: "Regression_delay"
output: github_document
---


```{r setup, include=FALSE}
#Setup

library(tidyverse)
library(viridis)
library(modelr)
library(mgcv)
library(dplyr)
library(tidyr)
library(skimr)
library(plotly)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
set.seed(1)
```


```{r data wrangling, include=FALSE}
#Dataset
delay = read.csv("./tidied_data/delay.csv") %>% 
  janitor::clean_names() %>% filter(delay_minutes > 0)

h_weather = read.csv("./tidied_data/hourly_weather.csv") %>% 
  janitor::clean_names() 

#Check how many airlines
unique(delay$airline_name) #_7_ -> ok, keep

#Check how many destinations
unique(delay$destination_airport) #_66_ -> too many, remove

#Keep variables of interest and `date` for merge purpose (which will be removed later) 
## Clean dataset 'delay'
delay = delay %>% 
  rename(
    airline = airline_name,
    hour = scheduled_hour,
    delay = delay_minutes,
    carrierd = delay_carrier_minutes,
    extrmwd = delay_weather_minutes,
    nasd = delay_national_aviation_system_minutes,
    securityd = delay_security_minutes,
    latarrd = delay_late_aircraft_arrival_minutes) %>% 
  mutate(hour = as.numeric(hour),
         month = as.factor(month.abb[month]),
         airline = as.factor(airline)) %>% 
  select(airline, date, month, hour, delay, carrierd, extrmwd, nasd, securityd, latarrd)
  
#check 'NA'
sum(is.na(delay)) #_0_ -> good

## Clean dataset 'h_weather'
### About the measure of temperature: Since the dry bulb temperature is the ambient air temperature measured by regular thermometers, that is, the temperature often mentioned in our general weather forecast. Thus, we decide to use the variable `hourly_dry_bulb_temperature` to represent temperature.
h_weather = h_weather %>% 
  rename(
    temperature = hourly_dry_bulb_temperature,
    humidity = hourly_relative_humidity,
    visibility = hourly_visibility,
    wind_s = hourly_wind_speed) %>% 
  mutate(hour = as.numeric(hour),
         month = as.factor(month.abb[month])) %>% 
  select(date, month, hour, temperature, humidity, visibility, wind_s)

#check 'NA'
sum(is.na(h_weather)) #_0_ -> good

## Merge datasets 'delay' and 'hourly_weather'

raw_df = merge(x = delay, y = h_weather, by = c("date", "month", "hour"),
               all.x = TRUE) %>% 
  mutate(hour_c = cut(hour, breaks = c(4, 8, 13, 17, 24),
                      labels = c("morning","noon","afternoon","night"))) %>% 
  mutate(hour_c = as.factor(hour_c)) %>% 
  select(-hour)

#check 'NA'
sum(is.na(raw_df)) #_0_ -> good

###To this step, we have our raw dataset for doing association analysis. Since the outcome variable `delay` is a continuous variable, we would do linear regression. However, there might be too many variables so far (ignoring `date` we still got 12 potential predictors), so next step will be fitting the model.

### By intuition, I would set: `airline` -> categorical `month` -> categorical `hour` -> categorical (need further categorization); and for the rest -> continuous

## Inspections into the dataset

# Let's first check how each variable is roughly distributed.

### Dependent variable / outcome (continuous)
###See if our dependent variable `delay` follows a normal distribution.

#his_plot = raw_df %>% 
  #plot_ly(x = ~delay, 
   #type = "histogram", marker = list(color = 'rgb(255, 156, 128)'))

#his_plot %>% 
         #layout(
         #title = 'Distribution of hourly delay in time, 2021/11/1 to 2022/1/31',
         #xaxis = list(title = "Hourly delay in minutes", tickangle = -45),
         #yaxis = list(title = "Frequency"))

### No, our dependent variable `delay` is not normally distributed, but we dont want to remove those outliers since they are important to our analysis. -> It is okay because for linear regression, dependent variable does not have to be normally distributed. On the other hand, the model's residuals, do have to be normally distributed. 
```

# Overview

...

# Data description

...

# Step 1: Data Exploration

put it here OR put in the exploration page

## Check distribution of the outcome (continuous)

if not related to modeling, delete, or include it in the exploration page.

```{r}
his = raw_df %>% 
  plot_ly(x = ~delay, 
   type = "histogram", marker = list(color = 'rgb(255, 156, 128)'))

his %>% 
         layout(
         title = 'Distribution of hourly delay in time, 2021/11/1 to 2022/1/31',
         xaxis = list(title = "Hourly delay in minutes", tickangle = -45),
         yaxis = list(title = "Frequency"))
```

## Explore the effect of potential predictors

_Motivation:_

To get a sense of the effect of each predictor.


_Plan:_

* For categorical variables:

We first produce boxplots to visualize the distribution of delay time across each categorical group. Then, we perform ANOVA to see if each group have the same average delay time. For those significant, we perform pairwise t-tests using Bonferroniâ€™s correction for the p-values to calculate pairwise differences between the delay time of each group.

* For continuous variables:

We first produce scatterplots to visualize the relationship between the continuous outcome and each continuous predictor to see if there is a linear relationship. We also calculate Pearson correlation coefficients for all continuous variables to measure the associations and detect if any strong linear correlations.


### Categorical predictors

```{r function for boxplot, include=FALSE}
box_cat = function(cat){
  
  box = raw_df %>% 
  plot_ly(x = ~cat, y = ~delay, color = ~cat,
          type = 'box', colors = "viridis") %>%  
  layout(
    yaxis = list(title = "Delay Time (minutes)"))

}
```


Airlines

```{r}
#boxplot
box_cat(raw_df$airline) %>% 
  layout(xaxis = list(title = "Airline"))

#One-way ANOVA
aov(delay ~ airline, data = raw_df) %>% summary()

#Pairwise t-tests (Bonferroni)
pairwise.t.test(raw_df$delay, raw_df$airline, p.adjust.method = "bonferroni")
```

_Highlights:_

* Since the overall p-value (<2e-16) is less than .05, this is an indication that each airline group does not have the same average delay time (in minutes).

* The adjusted p-value for the mean difference in delay time between American Airlines _vs._ JetBlue Airways is 3.6e-06.

* The adjusted p-value for the mean difference in delay time between Delta Air Lines _vs._ JetBlue Airways < 2e-16.


Months

```{r}
#boxplot
box_cat(raw_df$month) %>% 
  layout(xaxis = list(title = "Month"))

#One-way ANOVA
aov(delay ~ month, data = raw_df) %>% summary()

#Pairwise t-tests (Bonferroni)
pairwise.t.test(raw_df$delay, raw_df$month, p.adjust.method = "bonferroni")
```

_Highlights:_

* Since the overall p-value (<2e-16) is less than .05, this is an indication that each month group does not have the same average delay time.

* The adjusted p-value for the mean difference in delay time between November, 2021 _vs._ December, 2021 is .0015.

* The adjusted p-value for the mean difference in delay time between November, 2021 _vs._ January, 2022 and December, 2021 _vs._ January, 2022 both < 2e-16.


Times of the day ("hour_c")

```{r}
#boxplot
box_cat(raw_df$hour_c) %>% 
  layout(xaxis = list(title = "Times of the day"))

#One-way ANOVA
aov(delay ~ hour_c, data = raw_df) %>% summary()

#Pairwise t-tests (Bonferroni)
pairwise.t.test(raw_df$delay, raw_df$hour_c, p.adjust.method = "bonferroni")
```

_Highlights:_

* Since the overall p-value (0.000146) is less than .05, this is an indication that each hour group does not have the same average delay time.

* The adjusted p-value for the mean difference in delay time between morning _vs._ night is 6.7e-05.

* The adjusted p-value for the mean difference in delay time between noon _vs._ afternoon is 1.00.


### Continuous predictors

```{r function for scatterplot, include=FALSE}
scat_con = function(con){
  
  scat = raw_df %>%
  plot_ly(x = ~con, y = ~delay,
          type = 'scatter', mode = 'markers', alpha = .5) %>% 
    layout(
      yaxis = list(title = "Delay Time (minutes)"))
}
```


Carrier Delay

```{r}
scat_con(raw_df$carrierd) %>% 
  layout(xaxis = list(title = "Carrier Delay (minutes)"))
```


Extreme Weather Delay

```{r}
scat_con(raw_df$extrmwd) %>% 
  layout(xaxis = list(title = "Extreme Weather Delay (minutes)"))
```


Late Arrival Delay

```{r}
scat_con(raw_df$latarrd) %>% 
  layout(xaxis = list(title = "Late Arrival Delay (minutes)"))
```


NAS Delay

```{r}
scat_con(raw_df$nasd) %>% 
  layout(xaxis = list(title = "NAS Delay (minutes)"))
```


Security Delay

```{r}
scat_con(raw_df$securityd) %>% 
  layout(xaxis = list(title = "Security Delay (minutes)"))
```


Temperature

```{r}
scat_con(raw_df$temperature) %>% 
  layout(xaxis = list(title = "Temperature"))
```


Humidity

```{r}
scat_con(raw_df$humidity) %>% 
  layout(xaxis = list(title = "Humidity"))
```


Visibility

```{r}
scat_con(raw_df$visibility) %>% 
  layout(xaxis = list(title = "Visibility"))
```


Wind Speed

```{r}
scat_con(raw_df$wind_s) %>% 
  layout(xaxis = list(title = "Wind Speed"))
```


Pearson correlation 

```{r}
raw_df %>% 
  select(-date, -airline, -month, -hour_c) %>% 
  cor(y = raw_df$delay, x = .)
```

_Highlights:_

* A clear linear relationships is observed between delay time (the outcome) and Carrier Delay.
 
* The Pearson correlation coefficients are greater than .50 for the relationships between delay time and 2 predictors (i.e., carrier delay and late arrival delay). Noticeably, the correlation coefficient for the relationship between delay time and carrier delay is 0.80, which indicates a strong correlation.



# Step 2: Model fitting

According to the result from Step 1, we get a sense of what predictors should be included in the linear regression model. They are `airline`, `month`, `times in a day`, `carrier delay`, and `late arrival delay`.

Before fitting the linear model with these 5 predictors, let's check their independence using correlation to filter out highly correlated variables.


```{r}
cor = raw_df %>% 
  select(airline, month, hour_c, carrierd, latarrd) %>% 
  mutate(
    airline = as.numeric(airline),
    month = as.numeric(month),
    hour_c = as.numeric(hour_c)
    ) %>% 
  rename(
     "carrier delay" = carrierd,
     "late arrival delay" = latarrd,
    "times in a day" = hour_c) %>% 
  cor(method = c("pearson", "kendall", "spearman"))

round(cor, 2)

color = colorRampPalette(c("Blue", "white", "Red"))(20)
heatmap(x = cor, col = color, symm = TRUE)
```

_Highlights:_

* All predictors are highly independent to each other.


As we see above, independence assumption is met and thus we can add all these 5 predictors into to linear regression model.

## Linear regression, no interaction
```{r}
lm_pre = lm(delay ~ airline + month + hour_c + carrierd + latarrd, data = raw_df)
broom::glance(lm_pre) %>% select(r.squared, statistic, p.value, df) %>% mutate(p.value = recode(p.value, '0' = '<2.2e-16'))
```

_Highlights:_ 

* The R-squared value for this model is 0.854, which means more than 85% of the variance for delay time can be explained by this regression model.

* The F-value is 4818 (very large) with p-value < 2.2e-16 (very small), which suggests that this regression model is statistically significant.


