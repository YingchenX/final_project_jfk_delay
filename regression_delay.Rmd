---
title: "Regression_delay"
author: "Fengyi Ma"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(modelr)
library(mgcv)
library(dplyr)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
set.seed(1)
```

## Data Import

```{r}
delay = read.csv("./tidied_data/delay.csv") %>% 
  janitor::clean_names() 

h_weather = read.csv("./tidied_data/hourly_weather.csv") %>% 
  janitor::clean_names() 
```

## clean dataset 'delay'

Check how many airlines
```{r}
unique(delay$airline_name)
```
_7_ -> ok, keep

Check how many destinations
```{r}
unique(delay$destination_airport)
```
_66_ -> too many, remove

Keep variables of interest and `date` for merge purpose (which will be removed later) 
```{r}
delay = delay %>% 
  mutate(
    airline = airline_name,
    hour = scheduled_hour,
    delay_min = delay_minutes,
    carrierd_min = delay_carrier_minutes,
    extrmwd_min = delay_weather_minutes,
    nasd_min = delay_national_aviation_system_minutes,
    securityd_min = delay_security_minutes,
    latarrd_min = delay_late_aircraft_arrival_minutes) %>% 
  mutate(hour = as.numeric(hour)) %>% 
  select(airline, date, month, hour, delay_min, carrierd_min, extrmwd_min, nasd_min, securityd_min, latarrd_min)
```

check 'NA'
```{r eval=FALSE}
sum(is.na(delay))
```
_0_ -> good


## clean dataset 'h_weather'

About the measure of temperature:
Since the dry bulb temperature is the ambient air temperature measured by regular thermometers, that is, the temperature often mentioned in our general weather forecast. Thus, we decide to use the variable `hourly_dry_bulb_temperature` to represent temperature.

```{r}
h_weather = h_weather %>% 
  mutate(
    temperature = hourly_dry_bulb_temperature,
    humidity = hourly_relative_humidity,
    visibility = hourly_visibility,
    wind_s = hourly_wind_speed,
    hour = as.numeric(hour)) %>% 
      select(date, month, hour, temperature, humidity, visibility, wind_s)
```

check 'NA'
```{r eval=FALSE}
sum(is.na(h_weather))
```
_0_ -> good


## merge datasets 'delay' and 'hourly_weather'
```{r}
raw_df = merge(x = delay, y = h_weather, by = c("date", "month", "hour"),
               all.x = TRUE)
```

check 'NA'
```{r eval=FALSE}
sum(is.na(raw_df))
```
_0_ -> good
