---
title: "Poisson model"
output: github_document
---

```{r}
library(dplyr)
library(tidyverse)
library(ggridges)
library(patchwork)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))


cancel_raw = read_csv("tidied_data/cancel.csv")
covid = read_csv("tidied_data/covid.csv")
daily_weather = read_csv("tidied_data/daily_weather.csv")

```

# Outcome: mutate count cancellation data
Count numbers of cancellation by date
```{r}
cancel_date <- cancel_raw %>% 
  mutate(number = 1)%>% 
  mutate(number = as.numeric(number)) %>% 
  select(-flight_number,-destination_airport,-scheduled_hour,-scheduled_departure_time,-scheduled_elapsed_time_minutes) %>% 
  group_by(date) %>% 
  mutate(cancel_count = sum(number)) %>% 
  distinct

```


Count numbers of cancellation by airline and date
```{r}
cancel_airline <- cancel_raw %>% 
  mutate(number = 1)%>% 
  mutate(number = as.numeric(number)) %>% 
  select(-flight_number,-destination_airport,-scheduled_hour,-scheduled_departure_time,-scheduled_elapsed_time_minutes) %>% 
  group_by(date, airline_name) %>% 
  mutate(cancel_by_airline = sum(number)) %>% 
  distinct
```

```{r}
cancel <- cancel_date %>%
 inner_join(cancel_airline, by = c("airline_name", "date", "month", "day", "year", "number")) %>% 
 select(-number) 
```

# Merge outcome and predictors:

weather dataset: select `daily_average_dry_bulb_temperature`,  `daily_average_relative_humidity`, `daily_peak_wind_speed` predictors
```{r}
weather <- daily_weather %>% 
  mutate(
    temperature = daily_average_dry_bulb_temperature,
    humidity = daily_average_relative_humidity,
    windspeed = daily_peak_wind_speed
         )  %>% 
  select(date, year, month, day, temperature, humidity, windspeed) 
  
  
```

merge dataset 
```{r}
# merge weather and covid dataset
weather_covid <- weather %>% left_join(covid, by = c("date", "month", "day", "year"))

# merge cancel and weather_covid dataset
cancel_tidy <- weather_covid %>% 
  left_join(cancel, by = c("date", "month", "day", "year")) %>% 
  mutate(
    temperature = as.numeric(temperature),
    humidity = as.numeric(humidity),
    windspeed = as.numeric(windspeed),
    case_count = as.numeric(case_count),
    airline_name = as_factor(airline_name),
    month = ifelse(month == 11, "November", 
                        ifelse(month == 12, "December", "January"))) 
 
```

# Poisson model
```{r}
poisson = glm(cancel_count ~ temperature + humidity + windspeed + case_count + airline_name,family = "poisson",data=cancel_tidy)

summary(poisson)
```

# Poisson model Nested by month
```{r}
cancel_tidy %>% 
  nest(df = -month) %>%
  mutate(
    models = map(.x = df, ~ glm(cancel_count ~ temperature + humidity + windspeed + case_count + airline_name,family = "poisson", data = .x)),
    results = map(models, broom::tidy)
  ) %>% 
  unnest(results) %>% 
  select(month, term, estimate) %>% 
  mutate(term = fct_inorder(term)) %>% 
  pivot_wider(
    names_from = term, 
    values_from = estimate) %>% 
  knitr::kable(digits = 3)
```

