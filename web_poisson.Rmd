---
title: "Poisson model"
output: 
  html_document:
    toc: true
    toc_float: true
    output: 
  always_allow_html: true

---

```{r}
# install.packages("vars")

library(dplyr)
library(tidyverse)
library(ggridges)
library(patchwork)
library(plotly)
library(vars)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

cancel_airline = read_csv("tidied_data/cancel_airline.csv")
cancel_tidy = read_csv("tidied_data/cancel_tidy.csv")

```
# Overview
We wanted to investigate factors that are related to - and may be used to predict daily flight cancellation count. Weather factors and COVID breakouts or lockdowns, for example, might play crucial roles in daily flight cancellations, we treated them as our primary research interests, although we did not have any precise hypothesis. 

# Data description
In this research, we look for a relationship between cancellation and a number of variables. The number of cancellations each day is therefore regarded as the result (dependent variable), and exposures of interest are regarded as the independent variables.

* `daily_cancel`: daily flight cancellation count in JFK airport
* `temperature`: daily average dry bulb temperature
* `humidity`: daily average relative humidity
* `windspeed`: daily average relative windspeed
* `covid_case`: new daily cases of COVID-19
* `airline_name`: domestic airline 
* `year_month`: the date format in "Year Month"
* `covid_lag6`: daily cases of COVID-19 with 6 days time lag
 
# Pre-analysis
## Check distribution
Since our outcome, `daily_cancel`, is calculated using a count variable (number of cancellation) repeated over time, we modelled it using a Poisson regression model.
```{r}
# poisson distribution of counts
cancel_tidy %>% 
  plot_ly(x = ~daily_cancel, 
   type = "histogram", marker = list(color = 'rgb(255, 156, 128)')) %>% 
         layout(
         title= 'Distribution of daily flight cancellation, 2021/11/1 to 2022/1/31',
         xaxis = list(title = "Daily flight cancellation", tickangle = -45),
         yaxis = list(title = "Count"))

```

## Stratification factors
We discovered that the cancellation count each month varies by month and airline. Monthly f light cancellations were highest in January 2022, followed by December and November 2021. Monthly cancellation rates fluctuate greatly amongst airlines as well. As a result, we used the month and the airline as stratification factors.
```{r}
cancel_airline <- cancel_tidy  %>%
  group_by(year_month, airline_name) %>%
  mutate(Total_number_of_cancellation = sum(daily_cancel_by_airline)) %>%   
  dplyr::select(year_month, airline_name, Total_number_of_cancellation) %>%
  distinct %>%
  mutate(year_month = fct_relevel(year_month, "2021-Nov", "2021-Dec", "2022-Jan"))  

cancel_airline %>%
  pivot_wider(
  names_from = airline_name, 
  values_from = Total_number_of_cancellation) %>%
  head() %>% 
  knitr::kable(digits = 2, caption = "Monthly flight Cancellation numbers by month and airline") 

```


```{r}
bar_plot1 = cancel_airline %>% 
  mutate(year_month = fct_relevel(year_month, "2021-Nov", "2021-Dec", "2022-Jan")) %>% 
  plot_ly(x = ~year_month, y = ~Total_number_of_cancellation, color = ~airline_name, type = "bar", colors = "OrRd")  %>% 
  layout(xaxis = list(title = "Time"),
         yaxis = list(title = "Monthly flight cancellation numbers"),
         margin = list(b = 100),
         barmode = 'group')
bar_plot1

bar_plot2 = cancel_airline %>% 
  mutate(year_month = fct_relevel(year_month, "2021-Nov", "2021-Dec", "2022-Jan")) %>% 
  plot_ly(x = ~airline_name, y = ~Total_number_of_cancellation, color = ~year_month, type = "bar", colors = "OrRd")  %>% 
  layout(xaxis = list(title = "Airline Name", tickangle = -45),
         yaxis = list(title = "Monthly flight cancellation numbers"),
         margin = list(b = 100),
         barmode = 'group')
bar_plot2
```
## Create time-lag variable for COVID cases
We discovered that the time trend of daily flight cancellations and COVID-19 cases did not coincide with one other, which makes perfect sense in reality. The rise of COVID-19 cases frequently takes time to affect our daily lives. We had strong reasons to assume that `covid_case` may impact `daily_cancel` based on our hypothesis, thus we established new variables concerning `covid_case` with a time lag.

```{r}
cancel_covid <- cancel_tidy  %>%
  dplyr::select(date, daily_cancel, covid_case) %>% 
  distinct()

cancel_plot <-  cancel_covid  %>%
  mutate(text_label = str_c("Date: ", date, "\nCancellation flight: ", daily_cancel)) %>% 
  plot_ly(
    x = ~date, y = ~daily_cancel, type = "scatter", mode = "lines+markers",
   text = ~text_label, alpha = 0.5, name = 'Daily flight cancellation') %>% 
  layout(
         yaxis = list(title = "Daily flight cancellation"),
         annotations = list( 
    list(x = 0.1 , y = 0.8, text = "Daily flight cancellation", showarrow = F, xref='paper', yref='paper')))
         
covid_plot <-  cancel_covid  %>%
  mutate(text_label = str_c("Date: ", date, "\nCovid cases: ", covid_case)) %>% 
  plot_ly(
    x = ~date, y = ~covid_case, type = "scatter", mode = "lines+markers",
   text = ~text_label, alpha = 0.5, name = 'Daily covid cases') %>% 
  layout(
         yaxis = list(title = "Daily covid cases"),
         annotations = list( 
    list(x = 0.1 , y = 0.8, text = "Daily covid cases", showarrow = F, xref='paper', yref='paper')))

scatter_plot <- subplot(cancel_plot, covid_plot, nrows = 2) %>% 
  layout(title = list(text = "Time trend of daily cancellation vs. daily covid cases"),
         plot_bgcolor='#e5ecf6') 
scatter_plot


```
We used the lag selection criteria and Akaike's information criterion (AIC) to select 6 days as the optimal time lag. Then, we construct a new variable named `covid_lag6`, which indicates the value of COVID-19 cases with a 6-day time lag.
```{r}

VARselect(data.frame(cancel_covid$daily_cancel, cancel_covid$covid_case))

# Create a 1-day `covid_case` variable (using "lag()" from dplyr)
cancel_tidy$covid_lag6 <- lag(cancel_tidy$covid_case, 6)

```

# Poisson model
Poisson model:
```{r, echo = FALSE, out.width = "100%", fig.cap = "(Poisson model))", fig.align = 'center'}
knitr::include_graphics("./pictures/poisson_model.png")
```

```{r}
poisson = glm(daily_cancel ~ temperature + humidity + windspeed + covid_lag6,family = "poisson",data=cancel_tidy)


summary(poisson) 
```

# Poisson model Nested by month
```{r}
cancel_tidy %>% 
  nest(df = -month) %>%
  mutate(
    models = map(.x = df, ~ glm(daily_cancel ~ temperature + humidity + windspeed + covid_lag6,family = "poisson", data = .x)),
    results = map(models, broom::tidy)
  ) %>% 
  unnest(results) %>% 
  dplyr::select(month, term, estimate) %>% 
  mutate(term = fct_inorder(term)) %>% 
  pivot_wider(
    names_from = term, 
    values_from = estimate) %>% 
  knitr::kable(digits = 6, caption = "Poisson model nested by month")
```

## OR and 95% CI
```{r}
poisson_by_month = cancel_tidy %>%
  nest(data = -month) %>% 
  mutate(
    models = map(.x = data, ~glm(daily_cancel ~ temperature + humidity + windspeed + covid_lag6, family = "poisson", data = .x)),
    results = map(models, broom::tidy)
    ) %>% 
  dplyr::select(month, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error),
    p.value = format(p.value, scientific = TRUE, digits = 3)
  ) %>% 
  dplyr::select(month, term, OR, CI_lower,CI_upper, p.value) 

poisson_by_month %>% 
  filter(term != "(Intercept)" ) %>% 
  knitr::kable(digits = 3, align = "llccc", col.names = c("Month", "Terms", "Estimated adjusted OR", "CI lower bound", "CI upper bound", "P-value"), caption = "Overview of estimated OR, 95% CI and P-value")
```

## Plot
Create a plot showing the estimated ORs and CIs for each month

```{r}
poisson_by_month %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(x = month, y = OR, color = term)) + 
  geom_point(show.legend = FALSE, aes()) +
  geom_errorbar(aes(ymin = CI_lower, 
                    ymax = CI_upper)) +
  labs(
    title = "Estimated OR with 95% CI in Daily Flight Cancellation by Month",
    x = "Month",
    y = "Estimated OR with CI"
  ) +
  theme(legend.position="right", legend.title = element_blank(),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  facet_grid(. ~ term)

```


# Poisson model nested by airline


```{r}
cancel_tidy %>% 
  nest(df = -airline_name) %>%
  mutate(
    models = map(.x = df, ~ glm(daily_cancel ~ temperature + humidity + windspeed + covid_lag6,family = "poisson", data = .x)),
    results = map(models, broom::tidy)
  ) %>% 
  unnest(results) %>% 
  dplyr::select(airline_name, term, estimate) %>% 
  mutate(term = fct_inorder(term)) %>% 
  pivot_wider(
    names_from = term, 
    values_from = estimate) %>% 
  knitr::kable(digits = 6, caption = "Poisson model nested by airline")
```
## OR and 95% CI
```{r}
  
poisson_by_airline = cancel_tidy %>%
  nest(data = -airline_name) %>% 
  mutate(
    models = map(.x = data, ~glm(daily_cancel ~ temperature + humidity + windspeed + covid_lag6, family = "poisson", data = .x)),
    results = map(models, broom::tidy)
    ) %>% 
  dplyr::select(airline_name, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error),
    p.value = format(p.value, scientific = TRUE, digits = 3)
  ) %>% 
  dplyr::select(airline_name, term, OR, CI_lower,CI_upper, p.value) 

poisson_by_airline %>% 
  filter(term != "(Intercept)" ) %>% 
  knitr::kable(digits = 3, align = "llccc", col.names = c("Airline Name", "Terms", "Estimated adjusted OR", "CI lower bound", "CI upper bound", "P-value"), caption = "Overview of estimated OR, 95% CI and P-value")
```

## Plot
Create a plot showing the estimated ORs and CIs for each airline

```{r}
poisson_by_airline %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(x = airline_name, y = OR, color = term)) + 
  geom_point(show.legend = FALSE, aes()) +
  geom_errorbar(aes(ymin = CI_lower, 
                    ymax = CI_upper)) +
  labs(
    title = "Estimated OR with 95% CI in Daily Flight Cancellation by Airline",
    x = "Airline",
    y = "Estimated OR with CI"
  ) +
  theme(legend.position="right", legend.title = element_blank(),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  facet_grid(. ~ term)

```

